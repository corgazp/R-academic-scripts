---
title: "PEC 3"
author: "Miguel Angel Lopez Gonzalez, Cristian Orgaz Portero"
date: "21/5/2021"
output: html_document
csl: acs-chemical-biology.csl
bibliography: bibliografia.bib
runtime: shiny
---

# Sección 1

## Apartado 1

El conjunto de datos elegido ha sido <em>Meningitis</em>[@web] el cual recoge un total de 581 paciente de meningitis aguda causada o bien por infección vírica o bien por infección bacteriana. Este estudio fue publicado en 1989 y fue realizado en el <em>Duke University Medical Center</em>. El motivo por el cual hemos elegido este conjunto de datos ha sido por su tamaño de muestra y por el conocimiento general que se tiene sobre esta enfermedad lo cual facilita entender las variables que se estudian y lo posible valores que adoptan. 

```{r}
# Cargamos el paquete foreign para leer el fichero en formato dta que hemos descargado.
library(foreign)
meningitis<-read.dta(file = "abm.dta")
```

## Apartado 2

Hemos importado un fichero .dta, compatible con STATA. En el apartado anterior hemos importado el fichero a través de la función "read.dta", la cual para invocarla hemos tenido que cargar previamente el paquete foreign.

![](captura_DTA.jpg "Muestra del fichero importado")

```{r}
class(meningitis)
```

Comprobamos que el conjunto de datos se ha cargado como un data frame.

```{r}
dim(meningitis)
```

El data frame a estudio tiene un total de 43 variables y 581 observaciones.

```{r}
str(meningitis)
```

Estas 43 variables se dividen en 3 clases: + 3 son factores con dos niveles cada una. - 4 de ellas son numéricas. + 36 de ellas son números enteros.

## Apartado 3

- Nombre de las variables que forman el conjunto de datos

```{r}
names(meningitis)
```

- Determinar si hay valores NA y qué variables los contienen

```{r}
table(is.na(meningitis))
```

Sí existen valores NA.

```{r}
dim(meningitis[complete.cases(meningitis),])
```

Todas las variables contienen valores NA

- Media de edad de los pacientes estudiados

```{r}
mean(meningitis$age, na.rm = TRUE)
```

- Rango de edad de los paciente estudiados

```{r}
rango <- max(meningitis$age, na.rm = T)-min(meningitis$age, na.rm = T)
rango
```

- ¿ Qué número de personas han padecido meningitis aguda bacteriana (En adelante ABM por sus siglas en inglés)? (En la variable abm del presente data frame, las personas que padecieron ABM tienen valor de 1)

```{r}

# Omitimos los valores NA creando un nuevo vector

abm_sin_NA <- na.omit(meningitis$abm)
contador_abm <- 0
for (i in 1:length(abm_sin_NA)) {
  if (abm_sin_NA[i]==1)
    contador_abm <- contador_abm+1
}
print(contador_abm)
```

- ¿Cuáles el nivel medio de glóbulos blancos de aquellos pacientes que padecieron ABM?

```{r}
mean(meningitis$wbc[meningitis$abm==1], na.rm = T)
```

## Apartado 4

En este apartado vamos a realizar un análisis descriptivo de los datos para ello vamos a emplear la función summary () para obtener la estadística básica del conjunto de datos.

```{r}
summary(meningitis)
```

Mediante el uso de la función str conocemos el tipo de variables que presenta nuestro conjunto de datos.

```{r}
str(meningitis)
```
Dada la complejidad del conjunto de datos en su versión completa vamos a crear otro conjunto a partir de este escogiendo las variables que usaremos más adelante para realizar un modelo de regresión lineal simple y multiple. Para ello vamos a elegir las variables edad, sexo, raza, wbc, glucosa en sangre, glucosa en líquido cerebrospinal, proteínas en líquido cerebroespinal y abm.

Creamos el conjunto de datos reducido con la función data.frame y le pasamos las variables anteriores, también aprovechamos para renombrar algunas de las columnas y conocer mejor a qué hacen referencia cada una. En adelante, usaremos CSF (Cerebrospinal Fluid) para referirnos al líquido cerebroespinal donde se midieron niveles de glucosa y proteína.
```{r}
meningitis_min<-data.frame(meningitis$age,meningitis$sex,meningitis$race,meningitis$bloodgl,meningitis$gl,meningitis$pr,meningitis$abm)
names(meningitis_min)<-c( "Edad","Sexo","Raza","Glucosa_sangre","Glucosa_CSF","Proteina_CSF","ABM")
```

A continuación vamos a realizar algunos gráficos para continuar conociendo mejor el conjunto de datos. Elaboraremos tablas de frecuencias absolutas para las variables cualitativas como Sexo, Raza y ABM. También elaboraremos un histograma para la variable Edad y boxplot para las variables, Glucosa_sangre, Glucosa_CSF y Proteína_CSF

Generamos el histograma de la variable edad.Para ello usamos la función hist() y pasamos la variable edad filtrada sin NA.
```{r}
hist(na.omit(meningitis_min$Edad))
```
Generamos la tabla de frecuencias absolutas de las variables sexo y raza. Para ello empleamos la función table() a la cual le pasamos las variables filtradas sin NA.
```{r}
table(na.omit(meningitis_min$Sexo))
table(na.omit(meningitis_min$Raza))
```

Para genera la tabla de frecuencias absolutas de la variable ABM primero transformamos los valores de la variable 0 y 1 al tipo de meningitis del que se trata 0 para viral y uno para bacteriana. Para ello hacemos uso de la función factor() y pasamos la variable, los valores que toma y por cuales usaremos a partir de ahora, también excluimos los NA.

```{r}
meningitis_min$ABM<-factor(meningitis_min$ABM,levels = c(0,1),labels = c("viral","bacterial"),exclude = NA)
table(na.omit(meningitis_min$ABM))
```
A continuación, vamos a realizar los gráficos boxplot para las variables Glucosa_sangre, Glucosa_CSF y Proteína_CSF.

Analizando el boxplot para la variables Glucosa_sangre vemos una caja simétrica, con una mediana casi cercana a la media, signo de que la variable sigue una distribución normal. Encontramos valores "outliers" por encima de 400 e incluido un valor cercano a 0.
```{r}
boxplot(na.omit(meningitis_min$Glucosa_sangre))
```

Si ahora observamos el boxplot para la varible Glucosa_CSF vemos un boxplot que presenta asimetría, con una caja más ancha que para la variable anterior lo cual implica un rango intercuartílico mayor y por lo tanto una mayor dispersión entre los datos. Vemos que la mediana no se encuentra centrada aunque solo un poco desplazada del centro de la caja, pudiendo asumir asimetría negativa. En este caso también encontramos "outliers". 

```{r}
boxplot(na.omit(meningitis_min$Glucosa_CSF))
```
Por último, si observamos el boxplot para la variable Proteína_CSF nos encontramos,nuevamente, ante un boxplot asimétrico, cuya asimetría es más evidente, con una caja inferior a las dos anteriores con una mediana que roza el primer cuartil y una asimetría positiva. En este caso encontramos "outliers" muy por encima del rango intercuartílico.

```{r}
boxplot(na.omit(meningitis_min$Proteina_CSF))
```

## Apartado 5
La concentración de glucosa en sangre en nuestro conjunto de datos puede suponerse que sigue una distribución normal. Lo primero que vamos a calcular es la media y la desviación típica del vector meningitis$bloodgl, para ello tenemos que omitir los valor NA. 

```{r}
mean(na.omit(meningitis$bloodgl))
sd(na.omit(meningitis$bloodgl))
``` 


También vamos a comprobar que realmente esta variable sigue una distribución normal usando un gráfico de cuantiles teóricos.Cuanto más se aproxima a la una distribución normal, más alineado están los datos respecto a la recta.

```{r}
qqnorm(meningitis$bloodgl, pch = 19, col = "gray50")
qqline(meningitis$bloodgl)
```

Una vez hemos comprobado que la distribución que sigue esta variable puede aproximarse a una normal y conocemos que su media es 138.0 mg/dl y su desviación estándar es 54.4 mg/dl. Podemos plantearnos las siguientes cuestiones.

a)¿Cuál es la probabilidad de que la concentración de glucosa en sangre sea mayor 200 mg/dl?
```{r}
1-pnorm(200,mean = 138,sd = 54.4)
```

b)¿Cuál es la probabilidad de que la concentración de glucosa en sangre sea menor o igual a 130 mg/dl?

```{r}
pnorm(130,mean = 138,sd = 54.4)
```
c)¿Cuál es la probabilidad de que la concentración de glucosa en sangre esté entre 150 y 250 mg/dl?

```{r}
#P[150 ≤ X ≤ 250] -> la probabilidad puede reescribirse como
#P[150 ≤ X ≤250] = P[X ≤ 250] – P[ X ≤  150]
pnorm(250, mean = 138, sd = 54.4)-pnorm(150, mean = 138, sd = 54.4)
```

La meningitis es una enfermedad la cual puede presentar signos a nivel tópico, a partir de esta premisa vamos a generar una simulación con 581 valores para este hecho el cual seguirá una distribución binomial, o muestra signos o no los muestra, y cuya probabilidad de encontrarlos es de 0.41 tras 50 observaciones. También vamos a generar el histograma para la muestra.

```{r}
manchas_piel<-rbinom(581,50,0.41)
hist(manchas_piel, main="histograma para manchas en piel")
```

## Apartado 6

En este apartado vamos realizar un estudio regresión lineal y múltiple para el conjunto de datos meningitis_min. Lo primero que vamos a hacer es crear un subconjuto de datos en el cual solo trabajaremos con las variables numéricas. Para ello creamos el conjunto numeric_meningitis que recogerá las variables Edad, Glucosa_sangre, Glucosa_CSF y Proteina_CSF.

```{r}
numeric_meningitis<-data.frame(meningitis_min$Edad,meningitis_min$Glucosa_sangre,meningitis_min$Glucosa_CSF,meningitis_min$Proteina_CSF)
names(numeric_meningitis)<-c( "Edad","Glucosa_sangre","Glucosa_CSF","Proteina_CSF")
pairs(numeric_meningitis)
cor(na.omit(numeric_meningitis), method = "pearson")
```

El modelo de regresión lineal lo vamos a realizar entre las variables Glucosa_Sangre y Glucosa_CSF y lo que queremos comprobar es si existe una relación lineal entre la cantidad de glucosa en el líquido cerebroespinal y la cantidad de glucosa en sangre.

```{r}
modelo_lin_glucosa<-lm(numeric_meningitis$Glucosa_CSF~numeric_meningitis$Glucosa_sangre)
summary(modelo_lin_glucosa)
plot(numeric_meningitis$Glucosa_CSF,numeric_meningitis$Glucosa_sangre, xlab="Glucosa sangre", ylab="Glucosa CSF") 
abline(modelo_lin_glucosa)
```
El modelo lineal nos da un R-cuadrado múltiple y un R-cuadrado ajustado por debajo de 0.1 es por tanto este modelo no es capaz de explicar la relación entre la cantidad de glucosa en líquido cerebroespinal y la cantidad de glucosa en sangre.

Si ahora tratásemos de realizar un modelo de regresión múltiple para la misma variable, lo que se obtiene es lo siguiente.

```{r}
modelo_mul_glucosa<-lm(numeric_meningitis$Glucosa_CSF~numeric_meningitis$Glucosa_sangre+numeric_meningitis$Edad+numeric_meningitis$Proteina_CSF,data = numeric_meningitis)
summary(modelo_mul_glucosa)
```


Con la función step() vamos a evaluar cuales son los mejores predictores.

```{r}
step(object=modelo_mul_glucosa,direction ="both", trace=1)
```
Finalmente obtenemos que los mejores predictores son glucosa en sangre y proteína en líquido cerebroespinal.

```{r}
modelo_glucosa_sangre_predictors<-lm(numeric_meningitis$Glucosa_CSF~numeric_meningitis$Glucosa_sangre+numeric_meningitis$Proteina_CSF,data = numeric_meningitis)
summary(modelo_glucosa_sangre_predictors)
```
Obtenemos para este modelo de regresión múltiple con los mejores predictores un R-cuadrada ajustado y un R-cuadrado múltiple que duplican el valor del modelo lineal no obstante y dado lo alejado de 1 que se encuentran tampoco es un buen modelo para predecir la cantidad de glucosa en líquido cerebroespinal a partir de la glucosa en sangre y la proteína en líquido cerebroespinal.

## Apartado 7

Queremos determinar si existen o no diferencias significativas entre hombres y mujeres para el valor de glucosa en sangre mediante la aplicación de ANOVA.

En primer lugar vamos a crear un nuevo data frame con las variables con las que vamos a trabajar

```{r}
head(meningitis_min)
sexo <- c(meningitis_min$Sexo)
gluco_san <- c(meningitis_min$Glucosa_sangre)
df_sexo <- data.frame(sexo, gluco_san)
factor(df_sexo$sexo, levels = c(1,2), labels = c("male", "female"))
```

A continuación calculamos la media  y la desviación típica.

```{r}
aggregate(gluco_san~sexo, data = df_sexo, FUN = mean)
aggregate(gluco_san~sexo, data = df_sexo, FUN = sd)
```

Representamos gráficamente en un gráfico de cajas los valores de la variable para cada grupo para determinar si existen asimetrías en los datos o outliers:

```{r}
gluco_box <- boxplot(meningitis_min$Glucosa_sangre~meningitis_min$Sexo, data = meningitis_min, id.method = "y", xlab = "sexo", ylab = "Glucosa en sangre [mg/dl]")
gluco_box
```

A priori vemos que existen diferencias entre las dos variables. En ambos casos se detectan varios valores atípicos. El tamaño de las cajas el ligeramente superior para las mujeres, lo cual nos indica que sus valores tienen más dispersión. En ambos casos podemos apreciar que la distribución de los valores es bastante simétrica.

Realizaremos un estudio de normalidad para determinar si es factible la aplicación de ANOVa.

```{r}
par(mfrow=c(1,2))
qqnorm(df_sexo[df_sexo$sexo==1, "gluco_san"], main="Hombres")
qqline(df_sexo[df_sexo$sexo==1, "gluco_san"])
qqnorm(df_sexo[df_sexo$sexo==2, "gluco_san"], main="Mujeres")
qqline(df_sexo[df_sexo$sexo==2, "gluco_san"])
```

Los gráficos nos indican que para ambos grupos, los niveles de glucosa en sangre siguen una distribución normal, aunque con cola en su lado derecho.

Vamos a corroborar este hecho aplicando el test del Kolmogorov.Smirnov al ser, nuestra muestra, superior a las 50 observaciones.

```{r}
require(nortest)
by(data = df_sexo, INDICES = df_sexo$sexo, FUN = function(x){lillie.test(x$gluco_san)})
```

De los resultados se desprende que los datos para ambos grupos NO siguen una distribución normal, al ser el p-value inferior a 0.05.

Evaluamos a continuación la varianza constante entre los grupos mediante el test Fligner-Killeen.

```{r}
fligner.test(df_sexo$gluco_san~df_sexo$sexo, df_sexo)
```

Continuamos con el estudio de ANOVA

```{r}
anova_gluco_san <- aov(df_sexo$gluco_san~df_sexo$sexo, data = df_sexo)
summary(anova_gluco_san)

plot(anova_gluco_san)
```

El valor de P en este caso es holgadamente superior a 0.05, lo cual nos indica junto a las diferentes representaciones gráficas que puede que no haya diferencias significativas entre los dos grupos sometidos a estudio.
## Apartado 8

Es difícil establecer conclusiones finales con las pruebas practicadas sobre el conjunto de datos. Los métodos empleados, regresión lineal, múltiple y ANOVA, no han conseguido determinar relaciones entre los conjuntos de variables.

A lo largo de los apartados hemos tenido que ir reduciendo el conjunto de variables con el que se iba a trabajar para tratar de obtener conclusiones certeras y adecuadas. Llegándolo a reducir a un conjunto de datos con solo variables numéricas para llevar a cabo los correspondientes modelos de regresión.

Para la regresión lineal los ajustes han sido muy inferiores a 1, e incluso distantes al 0.5, lo cual nos indica que las variables escogidas no presentan relaciones lo suficientemente robustas.

Por otra parte con ANOVA sucede algo similar, los valores P obtenidos son superiores al nivel de confianza fijado de 0.05, lo cual nos hacer obliga a aceptar la hipótesis nula.

Uno de los motivos por los cuales no se han podido extraer conclusiones a partir de los test aplicados, puede radicar en la cantidad de valores NA presentes en el conjunto de datos, los cuales representan aproximadamente un 40% del total de valores del data frame y los cuales están presentes en todas las variables.
 
# Sección 2

El tema que hemos elegido para esta sección es la construcción de una aplicación web con shiny. La aplicación que hemos optado por construir es una donde vamos a poder elegir la media, el número de muestras y la desviación estándar y recrear como evoluciona el histograma de una variable que sigue una distribución normal. Para ello, hemos partido del ejemplo que encontramos para una aplicación creada con shiny y la hemos adaptado para obtener nuestra aplicación. 

Hemos añadido tres selectores de tipo "slider" para que se pueda seleccionar la media, la desviación estándar y el número de muestras. Estos datos que recogemos los empleamos para generar una distribución normal aleatoria y a continuación generar el histograma correspondiente. 
```{r}
library(shiny)

ui <- fluidPage(
  titlePanel("Histograma dinámico de variable normal"),
  sidebarLayout(
    sidebarPanel(
        sliderInput("media", "Escoge la media",10,1000,100),
        sliderInput("muestras", "Escoge el número de muestras",10,10000,10),
        sliderInput("desviacion","Escoge la desviación estándar",0.5,20,0.5)
        ),
    mainPanel(
      plotOutput(outputId = "variable_normal")

    )
  )
)
server <- function(input, output) {

  output$variable_normal <- renderPlot({

    x    <- rnorm(input$muestras,input$media,input$desviacion)

    hist(x, col = "#75AADB", border = "white",
         xlab = "Valores que adopta",
         main = "Histograma variable normal")
    })
    

}
shinyApp(ui = ui, server = server)
```

Centrándonos en el conjunto de datos que hemos elegido hemos optado por montar una aplicación en la cual a partir de una variable a escoger, mostramos una descriptiva básica de la misma, los cuales son, primeros y últimos valores, presencia de valores NA, el histograma y el boxplot correspondiente. 
```{r}
library(shiny)

ui <- fluidPage(
  titlePanel("Resumen de variable"),
  sidebarLayout(
    sidebarPanel(
        selectInput("variable","Escoge variable",c("Edad","Glucosa_sangre","Glucosa_CSF","Proteina_CSF"),names(meningitis_min$Edad))
        ),
    mainPanel(
      titlePanel("Primeros valores"),
      tableOutput(outputId ="head" ),
      titlePanel("Últimos valores"),
      tableOutput(outputId ="tail" ),
      titlePanel("Presencia de NA"),
      verbatimTextOutput(outputId="is_na"),
      titlePanel("Resumen estadístico básico"),
      verbatimTextOutput(outputId="summary"),
      titlePanel("Hisgrama de la variable"),
      plotOutput(outputId = "histogram"),
      titlePanel("Boxplot de la variable"),
      plotOutput(outputId = "box")
    )
  )
)
server <- function(input, output) {
  output$head<-renderTable(head(meningitis_min[input$variable]))
  output$tail<-renderTable({tail(meningitis_min[input$variable])})
  output$is_na<-renderPrint({table(is.na(meningitis_min[input$variable]))})
  output$summary<-renderPrint({summary(meningitis_min[input$variable])})
  output$histogram <- renderPlot({
    hist(meningitis_min[[input$variable]], col = "#75AADB", border = "white",
         xlab = "Valores que adopta",
         main = input$variable)
    })
  output$box <- renderPlot({
    boxplot(meningitis_min[[input$variable]],col = rgb(1, 0, 0, alpha = 0.4),
         main = input$variable)
    })


}
shinyApp(ui = ui, server = server)
```

## Bibliografia